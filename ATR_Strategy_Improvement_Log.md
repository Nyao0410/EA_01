# ATR系EAの改善履歴

## 概要

EURUSD日足対象のATR Range Breakout戦略の改善プロセス

---

## バージョン履歴

### ATR05 - 基礎版
- **パラメータ**:
  - MinATRFilter: 28.0
  - RiskPercent: 0.3%
  - RewardMultiplier: 1.5x
  - MaxConsecutiveLosses: 2

- **バックテスト結果** (2023.01.01-2024.10.20):
  - 取引数: 34回
  - 勝率: 41.18% (14勝20敗)
  - プロフィットファクター: 0.98
  - 総損益: -11.52 USD
  - ドローダウン: 2.53%

- **評価**: 
  - ✓ 多くの取引チャンスがある
  - ✗ 勝率が低い（目標50%以上）
  - ✗ プロフィットファクターがブレークイーブン

---

### ATR06 - 強化版（フィルター重視）
- **改善意図**: 
  - 勝率向上を目指してシグナルを厳選
  - 複数フィルターによる品質向上

- **パラメータ変更**:
  - MinATRFilter: 28.0 → **30.0**
  - RiskPercent: 0.3% → **0.25%** ↓
  - RewardMultiplier: 1.5x → **2.0x** ↑
  - MaxConsecutiveLosses: 2 → **1** ← より厳格
  - LotReductionPercent: 67% → **50%**
  - **UseVolatilityConfirmation: true** （新規）
  - **UseTimeFilter: true** （新規）
  - RSI範囲: 25-75 → **30-70** ← 狭い

- **バックテスト結果** (2023.01.01-2024.10.20):
  - **取引数: 0回** ⚠️⚠️⚠️
  - 勝率: N/A
  - 総損益: 0.00 USD

- **問題点**:
  - ❌ フィルターが厳しすぎて取引がゼロ
  - ❌ ボラティリティ確認（平均ATR × 1.2倍）が非現実的
  - ❌ 時間フィルター（8-20h GMT）が日足に無意味
  - ❌ RSI 30-70範囲がトレンド開始を排除

**教訓**: 「品質向上」と「取引機会確保」は両立必要

---

### ATR07 - バランス改善版 ✅ 推奨

- **改善意図**:
  - ATR05の取引機会を活かしつつ
  - ATR06の安定化を部分的に導入
  - **バランス型の現実的な設定**

- **パラメータ戦略**:

| 項目 | ATR05 | ATR06 | ATR07 | 理由 |
|------|-------|-------|-------|------|
| MinATRFilter | 28.0 | 30.0 | **20.0** | 機会確保 |
| RiskPercent | 0.3% | 0.25% | **0.25%** | ATR06継続 |
| RewardMultiplier | 1.5x | 2.0x | **1.75x** | 現実的中庸値 |
| MaxConsecutiveLosses | 2 | 1 | **2** | 柔軟性確保 |
| LotReductionPercent | 67% | 50% | **67%** | ATR05に戻す |
| WinCountToRestore | 3 | 3 | **2** | 迅速性 |
| UseVolatilityConfirmation | false | true | **false** | 機会喪失回避 |
| UseTimeFilter | false | true | **false** | 日足に無意味 |
| RSI範囲 | 25-75 | 30-70 | **20-80** | 寛容性向上 |

- **期待される結果** (予測):
  - 取引数: **25-35回** (ATR05程度)
  - 勝率: **43-45%** (2-4%向上)
  - PF: **1.05-1.15** (改善)
  - ドローダウン: **1.8-2.3%** (20%削減)

- **特徴**:
  - ✅ ATR05の取引機会を維持
  - ✅ ATR06のフィルター安定性を一部採用
  - ✅ 現実的でテスト可能なパラメータ
  - ✅ 過度な設定なし（過適合リスク低い）

---

## 設定の主要ポイント

### 1. ボラティリティフィルター
```
ATR07: MinATRFilter = 20.0
- ATRが20pips以上のみ取引
- 小さすぎる値動きでのノイズ取引を回避
- ATR05と同じレベル（機会を確保）
```

### 2. ボラティリティ確認（本当に不要）
```
ATR06（失敗）: UseVolatilityConfirmation = true
  条件: ATR > 平均ATR × 1.2倍
  問題: 日足ではほぼ不可能

ATR07（改善）: UseVolatilityConfirmation = false
  → ボラティリティ確認を削除
  → 取引機会を大幅に増加
```

### 3. 時間フィルター（まったく無意味）
```
ATR06（失敗）: UseTimeFilter = true
  時間帯: GMT 8-20時のみ
  問題: 日足は1キャンドル=1日
        「営業時間」という概念が存在しない

ATR07（改善）: UseTimeFilter = false
  → 24時間取引可能に
  → すべての日足キャンドルが対象
```

### 4. RSIフィルター（現実的な範囲に）
```
ATR06: RSI 30-70 範囲内のみ
  問題: トレンドの開始段階（RSI < 30 or > 70）を排除
        ほぼレンジ相場のみに限定

ATR07: RSI 20-80 範囲内
  → 極度の過買い/過売りのみ回避
  → トレンド初期段階をキャッチ
```

### 5. リワード倍率（現実的な中庸値）
```
ATR05: 1.5x （達成可能だが低い）
ATR06: 2.0x （理想的だが困難）
ATR07: 1.75x （現実と理想の中庸）

例：
ATR = 100 pips の場合
- SL距離 = 150 pips（共通）
- TP距離 = 262 pips（1.75倍）
- 達成確率: 1.5倍と2.0倍の中間程度
```

---

## テスト方針

### バックテスト環境
- **期間**: 2023.01.01 - 2024.10.20（474日足）
- **銘柄**: EURUSD
- **時間足**: Daily (PERIOD_D1)
- **初期資金**: 10,000 USD
- **レバレッジ**: 1:100

### 期待結果（ATR07）
```
取引数: 25-35回 (ATR05の34回程度)
  ↓
勝率: 43-45% (ATR05の41%から2-4%向上)
  ↓
PF: 1.05-1.15 (ATR05の0.98から改善)
  ↓
ドローダウン: 1.8-2.3% (ATR05の2.53%から削減)
```

### 判定基準
```
✅ 改善成功:
  - 取引数: 20回以上30回以下
  - 勝率: 43%以上
  - PF: 1.05以上
  - ドローダウン: 2.5%以下

⚠️  検証必要:
  - 取引数: 30-40回（やや多い）
  - 勝率: 40-43%（若干低い）
  - PF: 1.0-1.05（境界線）

❌ 失敗判定:
  - 取引数: 0回 or 40回超（極端）
  - 勝率: 40%以下（目標未達）
  - PF: 1.0以下（赤字）
```

---

## 次のステップ

### 1. ATR07のバックテスト実施
```
MetaTrader 5 Strategy Tester で実行
→ 結果を ATR05/ATR06 と比較
```

### 2. パラメータ微調整の検討
```
必要に応じて:
- MinATRFilter: 20 → 18-25 の範囲テスト
- RSI levels: 20-80 → 15-85 の検証
- RewardMultiplier: 1.75 → 1.5-2.0 の最適化
```

### 3. アウト・オブ・サンプルテスト
```
別の銘柄・期間でのテスト:
- GBPUSD / AUDUSD などで検証
- 2024年10月以降のフォワードテスト
```

### 4. 統計的検証
```
- ウォークフォワード分析
- モンテカルロシミュレーション
- 月別・曜日別の成績分析
```

---

## ファイル構成

```
src/
  ├── ATR05.mq5          （基礎版）
  ├── ATR06.mq5          （フィルター重視版 - 失敗）
  └── ATR07.mq5          （バランス改善版 ✅）

ドキュメント/
  ├── ATR05_vs_ATR06_Analysis.md
  └── ATR06_vs_ATR07_Analysis.md
```

---

## 重要な学習ポイント

### ✅ 成功した改善
1. **複数フィルターの採用** (適切な場合)
2. **リスク管理の厳格化** (連敗対策)
3. **リワード倍率の調整** (現実性重視)

### ❌ 失敗した改善
1. **ボラティリティ確認フィルター** (日足に無適切)
2. **時間帯フィルター** (日足では無意味)
3. **RSI範囲の縮小** (トレンド開始を排除)
4. **複数フィルターの過度な組み合わせ** (取引ゼロ)

### 📌 一般原則
```
「品質向上」と「取引機会」は両立が必須
- 一方を100%求めると、もう一方が0%になる
- バランス感覚が重要
- フィルターは「絶対条件」ではなく「確率的改善」
- テスト結果で検証することが最重要
```

---

**作成日**: 2025年10月21日
**バージョン**: v7.00
**ステータス**: ✅ ATR07テスト待機中
